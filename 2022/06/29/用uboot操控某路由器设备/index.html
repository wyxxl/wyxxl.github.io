<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><meta name="theme-color" content="#2d4356"><meta name="baidu-site-verification"><title>用uboot操控某路由器设备 | Tangle</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.png"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Tangle" type="application/atom+xml">
</head><link rel="stylesheet" type="text/css" href="/plugins/highlight/atom-one-dark.min.css"><script type="text/javascript" src="/plugins/highlight/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();
</script><script type="text/javascript" src="/js/ready.js" async></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><body class="night"><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/">LITREILY</a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/profile.jpg" width="128" height="128"></a><h1 class="ttl"><a href="/">Tangle</a></h1></div><p class="m-desc">Reading、Writing、Thinking、Hacking</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">归档</a></li><li><span class="dot">●</span><a href="/categories/">分类</a></li><li><span class="dot">●</span><a href="/tags/">标签</a></li><li><span class="dot">●</span><a href="/about/">关于</a></li><li><span class="dot">●</span><a href="/atom.xml">RSS</a></li><li class="m-sch"><form class="form" id="j-formsch" method="get"><input class="txt" type="text" id="local-search-input" name="q" value="搜索" onfocus="if(this.value=='搜索'){this.value='';}" onblur="if(this.value==''){this.value='搜索';}"><input type="text" style="display:none;"></form></li></ul><div id="local-search-result"></div></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">用uboot操控某路由器设备</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/">2022-06-29</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><h2 id="0x01-从uart-进入uboot-shell"><a href="#0x01-从uart-进入uboot-shell" class="headerlink" title="0x01.从uart 进入uboot shell"></a>0x01.从uart 进入uboot shell</h2><p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220324181647725.png" alt="image-20220324181647725"></p>
<p>某路由器设备拆开后找到了uart接口，将uart引脚通过TTL接入到电脑，路由器上电启动，观察启动日志.</p>
<pre><code class="shell">Boot SPI NAND
start read bootheader
start read secondboot
non secure boot 
Jump
ddr init enter, rate is 1333 mbps
ddr size is 0x10000000
U-Boot 2013.04 (Feb 14 2022 - 16:16:39)
......
eth0
Hit 1 to upgrade software version
Hit any key to stop autoboot:  1 
......
*****************pc start********************
*****************echo 5000 &gt; /proc/sys/vm/min_free_kbytes********************
close console 
</code></pre>
<p>从上面设备的部分启动日志可以看出，uboot shell可以被中断，路由器上电后快速按任意键可进入；路由器启动后关闭了console 控制台，不能通过console登录路由器。为了方便后续逆向工作，我们想要进入路由器系统，但目前是console已关闭，且未发现telnet、ssh等服务，只能从uboot shell为切入点进一步分析。</p>
<p>路由器reset，快速按下任意键进入boot shell，可以看到当前uboot shell支持的命令</p>
<pre><code class="shell">=&gt; h
?       - alias for &#39;help&#39;
base    - print or set address offset
bdinfo  - print Board Info structure
boot    - boot default, i.e., run &#39;bootcmd&#39;
bootd   - boot default, i.e., run &#39;bootcmd&#39;
bootk   - boot kernel
bootm   - boot application image from memory
bootz   - boot Linux zImage image from memory
cmp     - memory compare
coninfo - print console devices and information
cp      - memory copy
dhcp    - boot image via network using DHCP/TFTP protocol
downver - upgrade software downloaded from TFTP server
echo    - echo args to console
erase   - erase FLASH memory
fdt     - flattened device tree utility commands
flinfo  - print FLASH memory information
go      - start application at address &#39;addr&#39;
gpiotest- gpiotest dir [num] [in/out]
gpiotest value [num] [1/0]
gpiotest gvalue [num]
help    - print command description/usage
imxtract- extract a part of a multi-image
itest   - return true/false on integer compare
mcupg   -  multicast upgrade
md      - memory display
mii     - MII utility commands
mtddebug- mtddebug operate
mtest   - simple RAM read/write test
mw      - memory write (fill)
nand    - NAND sub-system
ping    - send ICMP ECHO_REQUEST to network host
printenv- print environment variables
protect - enable or disable FLASH write protection
reset   - Perform RESET of the CPU
run     - run commands in an environment variable
saveenv - save environment variables to persistent storage
setenv  - set environment variables
sleep   - delay execution for some time
snumber - Get or set serial number for zte boards
tftp    - boot image via network using TFTP protocol
version - print monitor, compiler and linker version
watchdog- watchdog reset &amp;&amp; disable
xmodem  - xmodem
</code></pre>
<h2 id="0x02-修改内核启动参数"><a href="#0x02-修改内核启动参数" class="headerlink" title="0x02.修改内核启动参数"></a>0x02.修改内核启动参数</h2><p>printenv查看当前环境变量</p>
<pre><code class="shell">=&gt; printenv
baudrate=115200
bome=aclcle) root=/dev/mtdblock8 rw rootfstype=jffs2 mem=256M single
bootcmd=setenv bootargs console=$(console) root=/dev/mtdblock8 ro rootfstype=jffs2  mem=$(memsize);bootm 0x440001e0;
bootdelay=1
bootfile=uboot.bin
bootloaderfile=bootloader.bin
console=ttyAMA0,115200n8
ethact=eth0
ethaddr=00:41:71:00:00:50
fileaddr=44000000
filesize=13bfb78
gatewayip=192.168.1.1
ipaddr=192.168.1.1
linuzfile=vmlinuz.bin
loadaddr=0x44000000
memsize=256M
nand_erasesize=20000
nand_oobsize=40
nand_writesize=800
netmask=255.255.255.0
netretry=5
serverip=192.168.1.100
</code></pre>
<p>bootargs为内核启动参数，这里没有看到init参数，一般来说，通过设置init参数来指定内核启动后第一个执行的脚本，可以尝试设置init&#x3D;&#x2F;bin&#x2F;sh进入linux shell。</p>
<pre><code class="shell">setenv bootcmd &#39;setenv bootargs console=$(console) root=/dev/mtdblock8 rw rootfstype=jffs2  mem=$(memsize) init=/bin/sh;bootm 0x440001e0;&#39;
</code></pre>
<p>用setenv修改bootcmd参数，保存环境变量。</p>
<pre><code class="shell">=&gt; save
Saving Environment to NAND...
Erasing 0x180000 - 0x200000:&lt;nand_erase_skip_bad_,1560&gt;!mtdpart=0x1,start=0x0,mtdpartoffset=0x180000,mtdPartsize=0x80000,length=0x80000
        [Done]
Writing to Nand:&lt;nand_write_skip_bad_,1455&gt;!mtdpart=0x1,offset=0x0,mtdpartoffset=0x180000,mtdPartsize=0x80000,length=0x20000
        [Done]
</code></pre>
<p>bootm启动发现失败，这里报错<code>can&#39;t get kernel image!</code></p>
<pre><code class="shell">=&gt; bootm 0x440001e0
Wrong Image Format for bootm command
ERROR: can&#39;t get kernel image!
</code></pre>
<p>下载一份u-boot-2013源码，搜索<code>can&#39;t get kernel image</code>字符串，定位到关键代码。</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220406180230602.png" alt="image-20220406180230602"></p>
<p>uboot首先会检测kernel的uimage头部信息，不正确会输出上面错误。kernel uimage是在kernel image前加上一段长度为64字节的头，用于描述内核的版本、加载位置等信息 ，uimage魔数一般是0x27051956，很明显0x440001e0地址的数据不符合，所以加载报错。</p>
<pre><code class="c">typedef struct image_header &#123;
    __be32		ih_magic;	/* Image Header Magic Number	*/
    __be32		ih_hcrc;	/* Image Header CRC Checksum	*/
    __be32		ih_time;	/* Image Creation Timestamp	*/
    __be32		ih_size;	/* Image Data Size		*/
    __be32		ih_load;	/* Data	 Load  Address		*/
    __be32		ih_ep;		/* Entry Point Address		*/
    __be32		ih_dcrc;	/* Image Data CRC Checksum	*/
    uint8_t		ih_os;		/* Operating System		*/
    uint8_t		ih_arch;	/* CPU architecture		*/
    uint8_t		ih_type;	/* Image Type			*/
    uint8_t		ih_comp;	/* Compression Type		*/
    uint8_t		ih_name[IH_NMLEN];	/* Image Name		*/
&#125; image_header_t;
#define IH_MAGIC	0x27051956	/* Image Magic Number		*/
#define IH_NMLEN		32	/* Image Name Length		*/
</code></pre>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220406180611516.png" alt="image-20220406180611516"></p>
<pre><code class="shell">=&gt; md.b 440001e0 100
440001e0: ff d7 ff ff bf fe fd f7 7f ff 7f df 5f bd ff ff    ............_...
440001f0: f6 a2 b7 f7 5f fe fe fe 77 f5 db ff 3f bf fa 76    ...._...w...?..v
44000200: fc ed ef fd 7f ff ff fd 7b ee ff ee fd 7b ff 75    ........&#123;....&#123;.u
44000210: 67 7d e8 bf ee ef ed a1 cd fb 63 fe 67 ee f7 9e    g&#125;........c.g...
44000220: f3 df af f5 ea ff f7 fb 78 77 ea fd df ff ef fb    ........xw......
44000230: d3 dd e9 ff b3 3f e7 ef 76 f6 f6 ed cf b3 bd fb    .....?..v.......
44000240: bf eb 97 fb 9f ef ff ef d9 59 b9 3e 5f 3f ff 32    .........Y.&gt;_?.2
</code></pre>
<p>正常情况下0x440001e0地址应该存放着kernel的uimage数据，这里不知什么原因kernel uimage未能正确加载到内存。既然内核未能正常加载到内存，那就尝试从手动从nand flash中读取内核到内存中。</p>
<pre><code class="shell">0x000000000000-0x000008000000 : &quot;whole flash&quot;
0x000000000000-0x000000200000 : &quot;u-boot&quot;
0x000006800000-0x000006b00000 : &quot;parameter tags&quot;
0x000000200000-0x000000700000 : &quot;kernel0&quot;
0x000000700000-0x000000c00000 : &quot;kernel1&quot;
0x000000c00000-0x000001400000 : &quot;usercfg&quot;
0x000001400000-0x000001500000 : &quot;others&quot;
0x000001500000-0x000001800000 : &quot;wlan&quot;
0x000001800000-0x000003800000 : &quot;rootfs0&quot;
0x000003800000-0x000005800000 : &quot;rootfs1&quot;
0x000005800000-0x000006000000 : &quot;framework&quot;
0x000006000000-0x000006800000 : &quot;framework1&quot;
0x000006b00000-0x000008000000 : &quot;apps&quot;
</code></pre>
<p>路由器正常启动的日志中，可以看到nand flash的13个分区，其中0x000000200000-0x000000700000 、0x000000700000-0x000000c00000存放这kernel数据，其中一个应该是做备份用。</p>
<p>nand dump查看nand flash中内核数据，uimage从0x2001e0开始</p>
<pre><code class="shell">=&gt; nand dump 0x200000
Page 00200000 dump:
    99 99 99 99 44 44 44 44  55 55 55 55 aa aa aa aa
    00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
    00 00 00 00 56 31 2e 30  2e 31 2e 32 32 30 33 31
    35 2e 31 37 30 39 33 33  00 00 00 00 00 00 00 00
    00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
    01 00 00 00 00 5a 64 01  17 58 24 00 e0 01 00 00
    dc e0 50 82 00 00 3c 01  00 5a 24 00 d2 2c 67 09
    00 00 20 00 00 00 50 00  00 00 80 01 00 00 00 02
    00 00 70 00 00 00 50 00  00 00 80 03 00 00 00 02
    5a 58 49 43 20 33 36 30  54 36 47 56 32 20 55 4e
    49 20 56 31 2e 30 2e 31  2e 32 32 30 33 31 35 2e
    31 37 30 39 33 33 00 00  00 00 00 00 00 00 00 00
    00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
    00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
    00 00 04 00 00 5a 60 01  31 52 b8 ea 56 32 5f 56
    32 2e 00 00 00 00 00 00  00 00 00 00 00 00 00 00
    01 00 00 00 47 9b 29 1d  32 30 32 32 30 33 32 31
    31 38 32 35 32 31 00 00  00 00 00 00 ff ff ff ff
    ff ff ff ff 00 00 00 10  ff ff 01 00 56 31 2e 30
    00 00 00 00 00 00 00 00  00 00 00 00 33 36 30 54
    36 47 56 32 00 00 00 00  00 00 00 00 15 56 24 56
    5a 58 30 31 03 30 00 00  00 e0 00 02 43 57 46 57
    31 37 30 33 32 38 31 30  30 31 00 00 ff ff ff ff
    ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff
    ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff
    ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff
    ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff
    ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff
    ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff
    ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff
    27 05 19 56 3c 35 3b 72  62 38 52 83 00 24 57 d7
    40 00 80 00 40 00 80 00  cc 1f fd e3 05 02 02 00
    4c 69 6e 75 78 20 4b 65  72 6e 65 6c 20 49 6d 61
</code></pre>
<p>使用nand read将nand flash中kernel分区数据加载到内存中，addr是ram的地址，off指的是nand flash的地址， size指要读取nand flash的数据大小。</p>
<pre><code class="shell">nand read - addr off|partition size

=&gt;nand read 0x44000000 0x200000 500000
NAND read: device 0 offset 0x200000, size 0x500000
 5242880 bytes read: OK
=&gt; md.b 0x440001e0 60
440001e0: 27 05 19 56 3c 35 3b 72 62 38 52 83 00 24 57 d7    &#39;..V&lt;5;rb8R..$W.
440001f0: 40 00 80 00 40 00 80 00 cc 1f fd e3 05 02 02 00    @...@...........
44000200: 4c 69 6e 75 78 20 4b 65 72 6e 65 6c 20 49 6d 61    Linux Kernel Ima
44000210: 67 65 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ge..............
44000220: 00 00 a0 e1 00 00 a0 e1 00 00 a0 e1 00 00 a0 e1    ................
44000230: 00 00 a0 e1 00 00 a0 e1 00 00 a0 e1 00 00 a0 e1    ................
</code></pre>
<pre><code class="shell">=&gt; bootm 0x440001e0
## Booting kernel from Legacy Image at 440001e0 ...
   Image Name:   Linux Kernel Image
   Image Type:   ARM Linux Kernel Image (uncompressed)
   Data Size:    2381783 Bytes = 2.3 MiB
   Load Address: 40008000
   Entry Point:  40008000
   Verifying Checksum ... OK
   Loading Kernel Image ... OK
OK
----------------------
|--&gt;setup versioninfo tag...

Starting kernel ...
</code></pre>
<p>再次bootm，成功启动，但是当内核尝试启动我们添加的启动参数init&#x3D;&#x2F;bin&#x2F;sh时失败了，未能成功进入linux shell，之后又重新用了默认启动参数重启。</p>
<pre><code class="shell">Set_Trap_Pkt_Pps_Limit is NULL.Set_Trap_Pkt_Pps_Limit is NULL.
VFS: Mounted root (jffs2 filesystem) on device 31:9.
Freeing unused kernel memory: 176K (c05b4000 - c05e0000)
This architecture does not have kernel memory protection.
Kernel panic - not syncing: Requested init /bin/sh; failed (error -2).
CPU: 1 PID: 1 Comm: swapper/0 Not tainted 4.1.25 #2
</code></pre>
<p>添加init参数未能成功启动，后面尝试修改文件系统，开启console、修改root密码，修改后的文件系统通过tftp上传到设备。</p>
<h2 id="0x03-uboot-tftp通信环境搭建"><a href="#0x03-uboot-tftp通信环境搭建" class="headerlink" title="0x03.uboot tftp通信环境搭建"></a>0x03.uboot tftp通信环境搭建</h2><p>uboot shell 支持tftp通信功能，这里先在ubuntu 18 PC机上安装tftp服务</p>
<pre><code class="shell">sudo apt install tftpd-hpa
</code></pre>
<p>检查tftpd-hpa服务是否正在运行</p>
<pre><code class="shell">sudo systemctl status tftpd-hpa
</code></pre>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629095150816.png" alt="image-20220629095150816"></p>
<p><strong>tftpd-hpa</strong>服务器的默认配置文件是**&#x2F;etc&#x2F;default&#x2F;tftpd-hpa<strong>。</strong>TFTP_DIRECTORY**是TFTP服务器访问目录。</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629095659437.png" alt="image-20220629095659437"></p>
<p>给<strong>TFTP_OPTIONS</strong>选项添加**–create**选项，否则无法创建新文件或将新文件上传到 TFTP 服务器。</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629095841941.png" alt="image-20220629095841941"></p>
<p>修改&#x2F;var&#x2F;lib&#x2F;tftpboot访问属性</p>
<pre><code class="shell">chmod 777 /var/lib/tftpboot
</code></pre>
<p>uboot shell环境变量中tftp的 serverip默认为192.168.1.100，这里我们直接将上面装有tftp服务器的ubuntu的ip地址设为192.168.1.100，</p>
<p>pc与路由器通过网线连接，尝试从tftp服务器下载个测试文件app.cgi到uboot，至此tftp通信环境已建立，下面修改文件系统上传到uboot。</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220330112532398.png" alt="image-20220330112532398"></p>
<h2 id="0x04-修改文件系统进入linux-shell"><a href="#0x04-修改文件系统进入linux-shell" class="headerlink" title="0x04.修改文件系统进入linux shell"></a>0x04.修改文件系统进入linux shell</h2><p>已经从网上下载到了设备固件，另外通过uboot也可以从flash的rootfs分区dump出文件系统。当前想通过修改固件开启console并修改登录密码，修改后的固件重新打包通过tftp上传到uboot，最后在刷到nand flash的文件系统分区。</p>
<p>前面了解到路由器正常启动时，串口日志最后打印了<code>close console</code>，可见根文件系统启动后直接关闭了console，导致不能通过串口登录到linux shell。解包设备固件，在程序中搜索<code>close console</code>字符串，发现该字符串出现在<code>/bin/cspd</code>程序中。</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629102259170.png" alt="image-20220629102259170"></p>
<p>找到关闭console的代码，直接patch掉。开启console后想要登录进linux shell还需要知道用户名、密码，可以考虑直接将&#x2F;etc&#x2F;passwd文件中root用户密码字段置空，后面登录时直接输入用户名root即可登录。</p>
<p>从上面的环境变量信息可以知道设备使用的是jffs2文件系统，将上面修改后的文件重新打包为jffs2格式，打包后的文件系统通过tftp下载到uboot，此时文件系统还只是在RAM中，断电或者重启后数据就会丢失，所以后面还需要将RAM中的文件系统数据用nand write命令写入到nand flash的文件系统分区。</p>
<pre><code class="shell">mkfs.jffs2 -d ./fs_1/ -l -e 0x20000 -o jffs2.img --no-cleanmarkers
</code></pre>
<p>通过上面步骤将修改后的文件系统刷入 nand flash文件系统分区后，重启设备，成功开启console，进入linux shell。</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629104835132.png" alt="image-20220629104835132"></p>
<h2 id="0x05-telnet-server-移植"><a href="#0x05-telnet-server-移植" class="headerlink" title="0x05.telnet server 移植"></a>0x05.telnet server 移植</h2><p>上面通过修改文件系统实现了从本地console进入到linux shell。设备默认没有telnet服务，为了方便后续管理设备，考虑移植个telnet server到设备中。</p>
<p>查看固件中程序信息,发现使用buildroot编译，所以尝试使用Buidroot 2017.05编译一个带有telnetd的busybox移植到设备。</p>
<pre><code class="shell">objdump -s --section=.comment Simulator
</code></pre>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629110336001.png" alt="image-20220629110336001"></p>
<p><a target="_blank" rel="noopener" href="https://buildroot.org/downloads/">https://buildroot.org/downloads/</a> 下载buildroot 2017.05版本</p>
<pre><code class="shell">make menuconfig
</code></pre>
<p>进入编译配置界面</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629110505003.png" alt="image-20220629110505003"></p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629110531814.png" alt="image-20220629110531814"></p>
<p>配置界面选项主要根据下图固件中文件的信息，ARM 、ELF32、LSB、EABI5 等配置，ld-linux.so.3说明用的是glibc库 。</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629110607230.png" alt="image-20220629110607230"></p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629110717800.png" alt="image-20220629110717800"></p>
<p>接着设置busybox相关选项，添加telnetd</p>
<pre><code class="shell">make busybox-menuconfig
</code></pre>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629110753723.png" alt="image-20220629110753723"></p>
<p>以上设置完成后执行<code>make</code>进行编译，编译完成后在当前目录会生成output文件夹，编译好的busybox在output文件夹中，生成的telnetd是链接到busybox的，所以这里直接将生成的busybox移植到路由器即可。将编译的busybox复制到固件文件系统&#x2F;bin目录并重命名为busybox2</p>
<p>在路由器文件系统自启动目录&#x2F;etc&#x2F;rcS.d下找个文件，加入busybox2 telnetd的启动命令</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220413185728443.png" alt="image-20220413185728443"></p>
<p>上面修改完成后，重新将文件打包成jffs2文件系统，然后通过tftp下载到uboot，最后nand write写入到nand flash文件系统，重启设备，telnet服务会自动启动，通过telnet客户端成功连接到路由器，后续动态调试移植gdbserver也可使用类似方法。</p>
<p><img src="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/image-20220629111625298.png" alt="image-20220629111625298"></p>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06.总结"></a>0x06.总结</h2><p>通过uart打断uboot进入uboot shell，给内核启动参数添加init未能成功启动；根据启动日志搜索关键字符串定位到关闭console的程序，patch二进制程序开启console，修改root密码，将修改后的文件重新打包通过tftp下载到uboot中，最后使用nand write写入到nand flash文件系统分区，实现从本地console进入到linux shell。最后使用Buidroot编译一个带有telnetd的busybox移植到设备，实现telnet登录到设备。 </p>
</div><div class="p-copyright"><blockquote><div class="p-copyright-link"><span class="p-copyright-key">本文链接：</span><span class="p-copytight-value"><a href="/2022/06/29/%E7%94%A8uboot%E6%93%8D%E6%8E%A7%E6%9F%90%E8%B7%AF%E7%94%B1%E5%99%A8%E8%AE%BE%E5%A4%87/">http://example.com/2022/06/29/用uboot操控某路由器设备/</a></span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tags"></i><a href="/tags/sec/">sec</a><a href="/tags/IoT-sec/">IoT sec</a></span></div><aside id="toc"><div class="toc-title">目录</div><nav><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E4%BB%8Euart-%E8%BF%9B%E5%85%A5uboot-shell"><span class="toc-number">1.</span> <span class="toc-text">0x01.从uart 进入uboot shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">0x02.修改内核启动参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-uboot-tftp%E9%80%9A%E4%BF%A1%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">0x03.uboot tftp通信环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%BF%9B%E5%85%A5linux-shell"><span class="toc-number">4.</span> <span class="toc-text">0x04.修改文件系统进入linux shell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-telnet-server-%E7%A7%BB%E6%A4%8D"><span class="toc-number">5.</span> <span class="toc-text">0x05.telnet server 移植</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">0x06.总结</span></a></li></ol></nav></aside></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2022/11/27/%E6%B5%85%E8%B0%88%E6%99%BA%E8%83%BD%E7%89%A9%E8%81%94%E7%BD%91%E5%AE%B6%E5%B1%85%E5%B9%B3%E5%8F%B0%E5%AE%89%E5%85%A8%E9%9A%90%E6%82%A3/">&lt; 浅谈智能物联网家居平台安全隐患</a><a class="next" href="/2021/03/20/buildroot%E6%9E%84%E5%BB%BAmips32%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/">buildroot构建mips32调试环境 &gt;</a></div><div id="valine-comment"><style type="text/css">.night .v[data-class=v] a { color: #0F9FB4 !important; }
.night .v[data-class=v] a:hover { color: #216C73 !important; }
.night .v[data-class=v] li { list-style: inherit; }
.night .v[data-class=v] .vwrap { border: 1px solid #223441; border-radius: 0; }
.night .v[data-class=v] .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.night .v[data-class=v] .vbtn { border-radius: 0; background: none; }
.night .v[data-class=v] .vlist .vcard .vh { border-bottom-color: #293D4E; }
.night .v[data-class=v] .vwrap .vheader .vinput { border-bottom-color: #223441; }
.night .v[data-class=v] .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.night .v[data-class=v] code, .night .v[data-class=v] pre,.night .v[data-class=v] .vlist .vcard .vhead .vsys { background: #203240 !important; }
.night .v[data-class=v] code, .night .v[data-class=v] pre { color: #F0F0F0; font-size: 95%; }
.v[data-class=v] .vcards .vcard .vh {border-bottom-color: #223441; }
.night .v[data-class=v] .vcards .vcard .vcontent.expand:before {background: linear-gradient(180deg,rgba(38,57,73,.4),rgba(38,57,73,.9));}
.night .v[data-class=v] .vcards .vcard .vcontent.expand:after {background: rgba(38,57,73,.9)}
</style><div id="vcomment"></div><script src="//cdn.bootcdn.net/ajax/libs/valine/1.4.14/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'',
  appKey:'',
  lang: 'zh-cn',
  placeholder:'ヾﾉ≧∀≦)o Come on, say something...',
  avatar:'identicon',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright © 2016 - 2024 <a href="/." rel="nofollow">Tangle</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
    search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script></body></html>